<div class="boxListHead">
    <div>
        <span>包厢列表(<span>4</span>/<span>20</span>)</span>
        <a href="javascript:$.nav('addBox')">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
        </a>
        <a href="javascript:void (0)" id="refresh">
            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
        </a>
    </div>
    <div class="filterBoxList">
        <label for="dateSelect">日期</label>
        <input type="date" id="dateSelect">
        <label for="bookStatus">预定状态</label>
        <select name="bookStatusSelect" id="bookStatus">
            <option value="1">全选</option>
            <option value="2">已预订</option>
            <option value="3">未预定</option>
        </select>
        <label for="paySelect">付款方式</label>
        <select name="payStatusSelect" id="paySelect" disabled="disabled">
            <option value="0">全选</option>
            <option value="1">未付款</option>
            <option value="2">微信支付</option>
            <option value="3">现金支付</option>
            <option value="4">刷卡支付</option>
        </select>
        <label for="telPhone"></label>
        <input type="text" id="telPhone" placeholder="请填写手机号">
        <button class="btn btn-xs btn-primary" id="btn-search">搜索</button>
    </div>
</div>
<div class="boxListBody">
    <table class="table table-hover">
        <thead>
        <tr>
            <th>#</th>
            <th>包厢号</th>
            <th>包厢状态</th>
            <th>付款方式</th>
            <th>联系人</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
<nav class="boxPagination">
    <span>每页显示15条</span>
    <span id="pageNum">第<span id="pageNumber">1</span>页</span>
    <ul>
        <li><a href="javascript:void (0)" id="prevPage">上一页</a></li>
        <li><a href="javascript:void (0)" id="nextPage">下一页</a></li>
    </ul>
</nav>
<div class="modal fade" id="bookModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">创建订单</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="boxBookId" class="control-label"></label>
                        <input type="text" class="form-control" id="boxBookId" placeholder="包厢号" readonly>
                    </div>
                    <div class="form-group">
                        <label for="boxBookType" class="control-label"></label>
                        <input type="text" class="form-control" id="boxBookType" placeholder="包厢类型" readonly>
                    </div>
                    <div class="form-group">
                        <label for="boxBookDate" class="control-label"></label>
                        <input type="text" class="form-control" id="boxBookDate" placeholder="预定时间" readonly>
                    </div>
                    <div class="form-group">
                        <label for="bookTelPhone" class="control-label"></label>
                        <input type="text" class="form-control" id="bookTelPhone" placeholder="手机号">
                    </div>
                    <div class="form-group">
                        <label for="bookPayment" class="control-label"></label>
                        <select name="payment" id="bookPayment" class="form-control">
                            <option value="1">暂不支付</option>
                            <option value="2">微信</option>
                            <option value="3">现金</option>
                            <option value="4">刷卡</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消订单</button>
                <button type="button" class="btn btn-primary" id="createOrder">确认订单</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="BookModalCancel" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">取消订单</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="boxBookIdCancel" class="control-label"></label>
                        <input type="text" class="form-control" id="boxBookIdCancel" placeholder="包厢号" readonly>
                    </div>
                    <div class="form-group">
                        <label for="boxBookTypeCancel" class="control-label"></label>
                        <input type="text" class="form-control" id="boxBookTypeCancel" placeholder="包厢类型" readonly>
                    </div>
                    <div class="form-group">
                        <label for="boxBookDateCancel" class="control-label"></label>
                        <input type="text" class="form-control" id="boxBookDateCancel" placeholder="预定时间" readonly>
                    </div>
                    <div class="form-group">
                        <label for="bookTelPhoneCancel" class="control-label"></label>
                        <input type="text" class="form-control" id="bookTelPhoneCancel" placeholder="手机号">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="cancelOrder">确认删除</button>
            </div>
        </div>
    </div>
</div>
<script>
    var num = 15;
    $("#pageNum").attr("data-pageNum", 1);
    var nowDate = function () {
        var today = new Date();
        var date = today.getDate().toString();
        var month = (today.getMonth() + 1).toString();
        var year = today.getFullYear().toString();
        if (date.length === 1)
            date = '0' + date;
        if (month.length === 1)
            month = '0' + month;
        return year + '-' + month + '-' + date;
    };
    var payMent = ['未付款', '微信支付', '现金支付', '刷卡支付'];
    function trGenertorYes(i, array, a) {
        var $tr = $("<tr></tr>");
        var $th = $("<th scope='row'></th>");
        $th.html(a + 1);
        var $td1 = $("<td></td>");
        var $td2 = $("<td></td>");
        var $td3 = $("<td></td>");
        var $td4 = $("<td></td>");
        var $td5 = $("<td></td>");
        $td1.html(array[i].boxNo);
        $td2.html("已预订");
        $td3.html(payMent[array[i].payment - 1]);
        $td4.html(array[i].telphone);
        var $btn = $("<button class='btn btn-xs btn-danger'>退订</button>");
        $btn.click(function () {
            $("#BookModalCancel").modal();
            var boxId = $(this).parent().parent().children().eq(1).html();
            var boxType = ['豪华包厢', '大包厢', '中包厢', '小包厢'];
            $("input#boxBookIdCancel").val(boxId);
            $("input#boxBookTypeCancel").val(boxType[$("#boxTypeName").attr('data-ti') - 1]);
            $("input#boxBookDateCancel").val($("#dateSelect").val());
            $("#bookTelPhone").empty();
        });
        $td5.html($btn);
        $tr.append($th).append($td1).append($td2).append($td3).append($td4).append($td5);
        $tr.hide();
        return {tr: $tr, payment: array[i].payment};
    }
    function trGenertorNo(i, array) {
        var $tr = $("<tr></tr>");
        var $th = $("<th scope='row'></th>");
        $th.html(i + 1);
        var $td1 = $("<td></td>");
        var $td2 = $("<td></td>");
        var $td3 = $("<td></td>");
        var $td4 = $("<td></td>");
        var $td5 = $("<td></td>");
        $td1.html(array[i].boxNo);
        $td2.html("未预定");
        $td3.html("无");
        $td4.html("无");
        var $btn = $("<button class='btn btn-xs btn-primary'>预定</button>");
        $btn.click(function () {
            $("#bookModal").modal();
            var boxId = $(this).parent().parent().children().eq(1).html();
            var boxType = ['豪华包厢', '大包厢', '中包厢', '小包厢'];
            $("input#boxBookId").val(boxId);
            $("input#boxBookType").val(boxType[$("#boxTypeName").attr('data-ti') - 1]);
            $("input#boxBookDate").val($("#dateSelect").val());
            $("input#bookTelPhone").empty();
            $("select#bookPayment").val(1);
        });
        $td5.html($btn);
        $tr.append($th).append($td1).append($td2).append($td3).append($td4).append($td5);
        $tr.hide();
        return $tr;
    }
    var findItemNum = function (boxNo, array) {
        for (var i = 0; i < array.length; i++)
            if (array[i].boxNo === boxNo)
                return i;
        return NaN;
    };
    var getAllBoxList = function (typeId, date, payStatus, items, numPage, bookStatus, pay=0) {
        $.get("/getAllBoxListsByTypeId", {typeid: typeId})
            .done(function (allBoxes) {
                $.get("/getBoxLists", {
                    typeId: typeId,
                    date: date,
                    payStatus: payStatus,
                    pageNum: 0
                }).done(function (boxesHasBooked) {
                        var $tbody = $("tbody");
                        $tbody.empty();
                        for (var i = 0; i < allBoxes.length; i++) {
                            if (bookStatus === 1) {
                                var num = findItemNum(allBoxes[i].boxNo, boxesHasBooked);
                                if (!isNaN(num))
                                    $tbody.append(trGenertorYes(num, boxesHasBooked, i).tr);
                                else
                                    $tbody.append(trGenertorNo(i, allBoxes));
                            }
                            else if (bookStatus === 2) {
                                num = findItemNum(allBoxes[i].boxNo, boxesHasBooked);
                                if (!isNaN(num)) {
                                    if (pay === 0)
                                        $tbody.append(trGenertorYes(num, boxesHasBooked, i).tr);
                                    else if (pay === trGenertorYes(num, boxesHasBooked, i).payment) {
                                        $tbody.append(trGenertorYes(num, boxesHasBooked, i).tr);
                                    }
                                }
                            }
                            else if (bookStatus === 3) {
                                num = findItemNum(allBoxes[i].boxNo, boxesHasBooked);
                                if (isNaN(num)) {
                                    $tbody.append(trGenertorNo(i, allBoxes));
                                }
                            }
                        }
                        paging(numPage, items);
                    }
                );
            }).fail(function () {
            alert("network error");
        });
    };
    var itemsShow = function (trs, start, end) {
        for (var i = 0; i < trs.length; i++) {
            if (i >= start && i <= end)
                trs.eq(i).show();
            else
                trs.eq(i).hide();
        }
    };
    var paging = function (page, num) {
        var trs = $("tbody>tr");
        if (page <= 0)
            itemsShow(trs, 0, num - 1);
        else if (page * num > trs.length)
            itemsShow(trs, trs.length - 1 - trs.length % 15, trs.length - 1);
        else if ((page - 1) * num < trs.length && page * num >= trs.length)
            itemsShow(trs, trs.length - 1 - trs.length % 15, trs.length - 1);
        else if (trs.length <= num)
            itemsShow(trs, 0, trs.length - 1);
        else
            itemsShow(trs, (page - 1) * num, page * num - 1);
    };
    $("#prevPage").click(function () {
        var pageNum = parseInt($("#pageNum").attr('data-pageNum'));
        if (pageNum > 1) {
            $("#pageNum").attr('data-pageNum', pageNum - 1);
            $("#pageNumber").html(pageNum - 1);
            paging(pageNum - 1, num);
        }
    });
    $("#nextPage").click(function () {
        var pageNum = parseInt($("#pageNum").attr('data-pageNum'));
        var length = $("tbody>tr").length;
        if (pageNum >= length / 15) {
        }
        else {
            $("#pageNum").attr('data-pageNum', pageNum + 1);
            $("#pageNumber").html(pageNum + 1);
            paging(pageNum + 1, num);
        }
    });
    $("#createOrder").click(function () {
        var boxId = $("#boxBookId").val();
        var boxDate = $("#boxBookDate").val();
        var boxPhone = $("#bookTelPhone").val();
        var payment = $("#bookPayment").val() || 1;
        $.ajax({
            url: '/bookBox',
            method: "POST",
            data: {
                'date': boxDate,
                'boxNo': boxId,
                'weixin': '',
                'telephone': boxPhone,
                'payment': payment
            }
        }).done(function (info) {
            if (info.result === 'success') {
                console.log("success");
            }
            else {
                console.log("failed");
            }
        }).fail(function () {
            console.log("server fail");
        }).always(function () {
            $("#bookModal").modal('hide');
            getAllBoxList($("#boxTypeName").attr("data-ti"), $("#dateSelect").val(), 2, num, parseInt($("#pageNum").attr("data-pageNum")), parseInt($("#bookStatus").val()));
        })
    });
    $("#cancelOrder").click(function () {
        var boxId = $("#boxBookIdCancel").val().trim();
        var boxDate = $("#boxBookDateCancel").val().trim();
        var boxPhone = $("#bookTelPhoneCancel").val().trim();
        $.ajax({
            url: '/bookBoxCancel',
            method: 'POST',
            data: {
                'date': boxDate,
                'boxNo': boxId,
                'telephone': boxPhone
            }
        }).done(function (info) {
            if (info.result === 'success') {
                console.log(info.data);
            }
            else {
                console.log(info.data);
            }
        }).fail(function () {
            console.log("server error");
        }).always(function () {
            $("#BookModalCancel").modal('hide');
            getAllBoxList($("#boxTypeName").attr("data-ti"), $("#dateSelect").val(), 2, num, parseInt($("#pageNum").attr("data-pageNum")), parseInt($("#bookStatus").val()), $("#paySelect").val());
        })
    });
    $("#refresh").click(function () {
        $("tbody").empty();
        getAllBoxList($("#boxTypeName").attr("data-ti"), $("#dateSelect").val(), 2, num, parseInt($("#pageNum").attr("data-pageNum")), parseInt($("#bookStatus").val()), $("#paySelect").val());
    });
    $("#btn-search").click(function () {
        getAllBoxList($("#boxTypeName").attr("data-ti"), $("#dateSelect").val(), 2, num, parseInt($("#pageNum").attr("data-pageNum")), parseInt($("#bookStatus").val()), $("#paySelect").val());
    });
    $("#bookStatus").change(function () {
        var bs = $(this).val();
        if (bs === 2)
            $("#paySelect").removeAttr('disabled');
        else {
            $("#paySelect").val(0).attr('disabled', 'disabled');
        }
    });
    $("#dateSelect").val(nowDate());
    getAllBoxList($("#boxTypeName").attr("data-ti"), $("#dateSelect").val(), 2, num, parseInt($("#pageNum").attr("data-pageNum")), parseInt($("#bookStatus").val()));
</script>
